From 8431dc07cc69fda5d6e74f916a1e6ac37a652465 Mon Sep 17 00:00:00 2001
From: Tom Fay <tom@teamfay.co.uk>
Date: Wed, 13 Nov 2024 22:08:55 +0000
Subject: [PATCH] Patch openssl provider for testing

---
 .gitignore                       | 1 +
 rustls/Cargo.toml                | 8 +++++++-
 rustls/src/crypto/mod.rs         | 2 ++
 rustls/src/lib.rs                | 2 +-
 rustls/src/test_macros.rs        | 7 +++++++
 rustls/src/tls13/key_schedule.rs | 3 ++-
 6 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/.gitignore b/.gitignore
index 0351088b..6dd1392d 100644
--- a/.gitignore
+++ b/.gitignore
@@ -10,3 +10,4 @@ admin/rustfmt
 **/._.DS_Store
 /.idea
 /default.profraw
+rustls/src/crypto/openssl/
diff --git a/rustls/Cargo.toml b/rustls/Cargo.toml
index b264ce9a..606a505f 100644
--- a/rustls/Cargo.toml
+++ b/rustls/Cargo.toml
@@ -31,9 +31,12 @@ webpki = { package = "rustls-webpki", version = "0.102.8", features = ["alloc"],
 pki-types = { package = "rustls-pki-types", version = "1.10", features = ["alloc"] }
 zeroize = "1.7"
 zlib-rs = { version = "0.3", optional = true }
+openssl = {version = "0.10"}
+openssl-sys = "0.9"
+foreign-types-shared = "0.1.1"
 
 [features]
-default = ["aws_lc_rs", "logging", "std", "tls12"]
+default = ["aws_lc_rs", "logging", "std", "tls12", "chacha", "x25519"]
 std = ["webpki/std", "pki-types/std", "once_cell/std"]
 logging = ["log"]
 aws_lc_rs = ["dep:aws-lc-rs", "webpki/aws_lc_rs"]
@@ -45,6 +48,9 @@ tls12 = []
 read_buf = ["rustversion", "std"]
 fips = ["aws_lc_rs", "aws-lc-rs?/fips"]
 zlib = ["dep:zlib-rs"]
+chacha = []
+x25519 = []
+
 
 [dev-dependencies]
 base64 = "0.22"
diff --git a/rustls/src/crypto/mod.rs b/rustls/src/crypto/mod.rs
index d970b545..ccb5424e 100644
--- a/rustls/src/crypto/mod.rs
+++ b/rustls/src/crypto/mod.rs
@@ -29,6 +29,8 @@ pub mod ring;
 #[cfg(feature = "aws_lc_rs")]
 pub mod aws_lc_rs;
 
+pub mod openssl;
+
 /// TLS message encryption/decryption interfaces.
 pub mod cipher;
 
diff --git a/rustls/src/lib.rs b/rustls/src/lib.rs
index 05356279..7635521d 100644
--- a/rustls/src/lib.rs
+++ b/rustls/src/lib.rs
@@ -311,7 +311,7 @@
 //!
 
 // Require docs for public APIs, deny unsafe code, etc.
-#![forbid(unsafe_code, unused_must_use)]
+#![forbid(unused_must_use)]
 #![cfg_attr(not(any(read_buf, bench)), forbid(unstable_features))]
 #![warn(
     clippy::alloc_instead_of_core,
diff --git a/rustls/src/test_macros.rs b/rustls/src/test_macros.rs
index 40a577ee..b6af971f 100644
--- a/rustls/src/test_macros.rs
+++ b/rustls/src/test_macros.rs
@@ -18,6 +18,13 @@ macro_rules! test_for_each_provider {
             use crate::crypto::aws_lc_rs as provider;
             $($tt)+
         }
+
+        #[cfg(test)]
+        mod test_with_openssl {
+            use crate::crypto::openssl as provider;
+            $($tt)+
+        }
+
     };
 }
 
diff --git a/rustls/src/tls13/key_schedule.rs b/rustls/src/tls13/key_schedule.rs
index 05aeba67..a124f5d9 100644
--- a/rustls/src/tls13/key_schedule.rs
+++ b/rustls/src/tls13/key_schedule.rs
@@ -903,7 +903,8 @@ test_for_each_provider! {
     use std::prelude::v1::*;
     use std::vec;
 
-    use provider::ring_like::aead;
+    // Since openssl doesn't have a ring_like module, use aws_lc_rs
+    use crate::crypto::aws_lc_rs::ring_like::aead;
     use provider::tls13::{
         TLS13_AES_128_GCM_SHA256_INTERNAL, TLS13_CHACHA20_POLY1305_SHA256_INTERNAL,
     };
-- 
2.33.8

