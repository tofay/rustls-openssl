From 3d19ba6b88f43b8281a346bb9b5e07c9598d8513 Mon Sep 17 00:00:00 2001
From: Tom Fay <tom@teamfay.co.uk>
Date: Thu, 14 Nov 2024 16:31:52 +0000
Subject: [PATCH] Patch openssl into rustls

---
 rustls/Cargo.toml                | 8 +++++++-
 rustls/src/crypto/mod.rs         | 2 ++
 rustls/src/lib.rs                | 2 +-
 rustls/src/test_macros.rs        | 7 +++++++
 rustls/src/tls13/key_schedule.rs | 3 ++-
 5 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/rustls/Cargo.toml b/rustls/Cargo.toml
index 2192377f..071d9036 100644
--- a/rustls/Cargo.toml
+++ b/rustls/Cargo.toml
@@ -32,8 +32,12 @@ pki-types = { package = "rustls-pki-types", version = "1.10", features = ["alloc
 zeroize = "1.7"
 zlib-rs = { version = "0.4", optional = true }
 
+openssl = {version = "0.10"}
+openssl-sys = "0.9"
+foreign-types-shared = "0.1.1"
+
 [features]
-default = ["aws_lc_rs", "logging", "std", "tls12"]
+default = ["aws_lc_rs", "logging", "std", "tls12", "chacha", "x25519", "read_buf", "fips", "zlib"]
 std = ["webpki/std", "pki-types/std", "once_cell/std"]
 logging = ["log"]
 aws_lc_rs = ["dep:aws-lc-rs", "webpki/aws_lc_rs"]
@@ -45,6 +49,8 @@ tls12 = []
 read_buf = ["rustversion", "std"]
 fips = ["aws_lc_rs", "aws-lc-rs?/fips"]
 zlib = ["dep:zlib-rs"]
+chacha = []
+x25519 = []
 
 [dev-dependencies]
 base64 = "0.22"
diff --git a/rustls/src/crypto/mod.rs b/rustls/src/crypto/mod.rs
index d970b545..ccb5424e 100644
--- a/rustls/src/crypto/mod.rs
+++ b/rustls/src/crypto/mod.rs
@@ -29,6 +29,8 @@ pub mod ring;
 #[cfg(feature = "aws_lc_rs")]
 pub mod aws_lc_rs;
 
+pub mod openssl;
+
 /// TLS message encryption/decryption interfaces.
 pub mod cipher;
 
diff --git a/rustls/src/lib.rs b/rustls/src/lib.rs
index 2c9b515a..8d11c8b7 100644
--- a/rustls/src/lib.rs
+++ b/rustls/src/lib.rs
@@ -311,7 +311,7 @@
 //!
 
 // Require docs for public APIs, deny unsafe code, etc.
-#![forbid(unsafe_code, unused_must_use)]
+#![forbid(unused_must_use)]
 #![cfg_attr(not(any(read_buf, bench)), forbid(unstable_features))]
 #![warn(
     clippy::alloc_instead_of_core,
diff --git a/rustls/src/test_macros.rs b/rustls/src/test_macros.rs
index 40a577ee..b6af971f 100644
--- a/rustls/src/test_macros.rs
+++ b/rustls/src/test_macros.rs
@@ -18,6 +18,13 @@ macro_rules! test_for_each_provider {
             use crate::crypto::aws_lc_rs as provider;
             $($tt)+
         }
+
+        #[cfg(test)]
+        mod test_with_openssl {
+            use crate::crypto::openssl as provider;
+            $($tt)+
+        }
+
     };
 }
 
diff --git a/rustls/src/tls13/key_schedule.rs b/rustls/src/tls13/key_schedule.rs
index 05aeba67..a124f5d9 100644
--- a/rustls/src/tls13/key_schedule.rs
+++ b/rustls/src/tls13/key_schedule.rs
@@ -903,7 +903,8 @@ test_for_each_provider! {
     use std::prelude::v1::*;
     use std::vec;
 
-    use provider::ring_like::aead;
+    // Since openssl doesn't have a ring_like module, use aws_lc_rs
+    use crate::crypto::aws_lc_rs::ring_like::aead;
     use provider::tls13::{
         TLS13_AES_128_GCM_SHA256_INTERNAL, TLS13_CHACHA20_POLY1305_SHA256_INTERNAL,
     };
-- 
2.33.8

